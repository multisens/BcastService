<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title><%= pageTitle %></title>
    <style>
      html,
      body {
        height: 100%;
        margin: 0;
        overflow: hidden; /* Esconde barras de rolagem */
      }
      body {
        font-family: sans-serif;
        text-align: center;
        color: white;

        background-image: url("/media/eduplay/images/quiz-screen.png");
        background-size: cover;
        background-position: center;
        background-repeat: no-repeat;
        background-attachment: fixed;
      }
      .container {
        display: none;
        width: 100vw;
        height: 100vh;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
      }
      #main-video {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        object-fit: cover;
        z-index: -1; /* Colocado atrás de todo o conteúdo */
      }
      #qrcode-overlay {
        display: none;
        position: fixed;
        bottom: 30px;
        right: 30px;
        padding: 10px;
        background-color: white;
        border-radius: 8px;
        z-index: 100;
      }
      #question-text {
        font-size: 3em;
        margin: 40px 20px;
      }
      #options-list {
        list-style-type: none;
        padding: 0;
        font-size: 1.8em;
        display: grid;
        grid-template-columns: 1fr;
        gap: 15px;
        width: 80%;
        max-width: 1000px;
      }
      #options-list li {
        padding: 20px;
        padding-left: 25px;
        border-radius: 5px;
        text-align: left;
        transition: transform 0.2s, border 0.2s;
      }
      .option-red {
        background-color: #e74c3c;
      }
      .option-green {
        background-color: #27ae60;
      }
      .option-yellow {
        background-color: #f1c40f;
        color: #333;
      }
      .option-blue {
        background-color: #2980b9;
      }
      .correct-answer {
        border: 5px solid #2ecc71;
        transform: scale(1.05);
        box-shadow: 0 0 20px #2ecc71;
      }
      /* --- NOVO: Estilo para o OVERLAY de estatísticas --- */
      #stats-overlay {
        display: none; /* Começa escondido */
        position: fixed;
        bottom: 0;
        left: 0;
        width: 100%;
        background-color: rgba(0, 0, 0, 0.8);
        padding: 15px 0;
        font-size: 2em;
        z-index: 200;
        justify-content: center;
        gap: 50px;
      }
      .stat-correct {
        color: #2ecc71;
      }
      .stat-incorrect {
        color: #e74c3c;
      }
    </style>
  </head>
  <body>
    <video id="main-video" autoplay playsinline></video>

    <div id="qrcode-overlay">
      <div id="qrcode"></div>
    </div>

    <div id="question-container" class="container">
      <div id="question-text"></div>
      <ul id="options-list"></ul>
    </div>

    <div id="stats-overlay"></div>

    <div id="end-container" class="container">
      <h1>O Quiz terminou!</h1>
      <p>Obrigado por jogar.</p>
    </div>

    <script src="/js/jquery-3.7.1.min.js"></script>
    <script src="/js/navigation.js"></script>
    <script src="/js/socket.io.min.js"></script>
    <script src="/js/qrcode.min.js"></script>


    <script>
      document.addEventListener('keydown', (e) => {navigate(e.key)});

      const roomId = "<%= roomId %>";
      const playerUrl = "<%= playerUrl %>";
      const socket = io("<%= logicServerUrl %>");

      const videoPlayer = document.getElementById("main-video");
      const qrCodeOverlay = document.getElementById("qrcode-overlay");
      const questionContainer = document.getElementById("question-container");
      const statsOverlay = document.getElementById("stats-overlay");
      const endContainer = document.getElementById("end-container");
      const questionTextEl = document.getElementById("question-text");
      const optionsListEl = document.getElementById("options-list");

      function showContainer(containerToShow) {
        [questionContainer, endContainer].forEach(
          (c) => (c.style.display = "none")
        );
        if (containerToShow) containerToShow.style.display = "flex";
      }

      socket.on("connect", () => {
        console.log(
          "Conectado. Registrando como apresentador da sala:",
          roomId
        );
        socket.emit("joinRoom", { roomId: roomId, isPresenter: true });
      });

      socket.on("playIntroVideo", (introVideo) => {
        console.log("Iniciando vídeo de introdução:", introVideo.src);
        showContainer(null);
        videoPlayer.style.display = "block";
        videoPlayer.src = introVideo.src;
        videoPlayer.play();

        setTimeout(() => {
          new QRCode(document.getElementById("qrcode"), playerUrl);
          qrCodeOverlay.style.display = "block";
        }, introVideo.qrCodeDelay * 1000);

        setTimeout(() => {
          qrCodeOverlay.style.display = "none";
        }, (introVideo.qrCodeDelay + introVideo.qrCodeDuration) * 1000);
      });

      socket.on("playVideo", ({ url }) => {
        console.log(`Recebido comando para tocar o vídeo: ${url}`);
        showContainer(null); // Esconde todos os contêineres de conteúdo
        statsOverlay.style.display = "none"; // Esconde o overlay de stats
        videoPlayer.style.display = "block";
        videoPlayer.src = url;
        videoPlayer.play();
      });

      socket.on("quiz:newQuestion", (question) => {
        console.log("Nova pergunta recebida:", question.text);
        videoPlayer.style.display = "none";
        statsOverlay.style.display = "none"; // Esconde o overlay de stats da pergunta anterior
        showContainer(questionContainer);

        questionTextEl.innerText = question.text;
        optionsListEl.innerHTML = "";

        const prefixes = ["A)", "B)", "C)", "D)"];
        const colorClasses = [
          "option-red",
          "option-green",
          "option-yellow",
          "option-blue",
        ];

        question.options.forEach((optionText, index) => {
          const li = document.createElement("li");
          // Adiciona a classe de cor correspondente
          li.classList.add(colorClasses[index]);
          // Adiciona o prefixo ao texto
          li.innerText = `${prefixes[index]} ${optionText}`;
          optionsListEl.appendChild(li);
        });
      });

      // --- LÓGICA MODIFICADA PARA EXIBIR RESULTADOS ---
      socket.on("quiz:endQuestion", ({ correctAnswerIndex, stats }) => {
        console.log("Fim da pergunta. Exibindo estatísticas:", stats);

        // 1. Destaca a resposta correta na lista que já está na tela
        const listItems = optionsListEl.getElementsByTagName("li");
        if (listItems[correctAnswerIndex]) {
          listItems[correctAnswerIndex].classList.add("correct-answer");
        }

        // 2. Preenche e exibe o overlay de estatísticas
        statsOverlay.innerHTML = `
            <div class="stat stat-correct">Acertos: ${stats.correct}</div>
            <div class="stat stat-incorrect">Erros: ${stats.incorrect}</div>
        `;
        statsOverlay.style.display = "flex";
      });

      socket.on("quizEnded", (message) => {
        console.log(message);
        videoPlayer.style.display = "none";
        statsOverlay.style.display = "none";
        showContainer(endContainer);
      });
    </script>
  </body>
</html>
